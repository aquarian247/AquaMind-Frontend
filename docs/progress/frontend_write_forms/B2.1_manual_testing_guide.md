# B2.1 Batch Creation - Manual Testing Guide

## Prerequisites

✅ Backend server running on `http://localhost:8000`
✅ Frontend server running on `http://localhost:5173`
✅ Database regenerated with Egg&Alevin lifecycle stage
✅ Test data loaded (1 geography, 1 station, 5 halls, 50 containers)

## Test Data Reference

**Geography**: Faroe Islands (ID: 1)
**Station**: Faroe Islands Freshwater Station 1 (ID: 1)
**Halls**:
- Hall A (ID: 1) - 10 Egg & Alevin Trays (IDs: 1-10)
- Hall B (ID: 2) - 10 Fry Tanks (IDs: 11-20)
- Hall C (ID: 3) - 10 Parr Tanks (IDs: 21-30)
- Hall D (ID: 4) - 10 Smolt Tanks (IDs: 31-40)
- Hall E (ID: 5) - 10 Post-Smolt Tanks (IDs: 41-50)

**Species**: Atlantic Salmon (ID: 1)
**Lifecycle Stage**: Egg&Alevin (ID: 1)

## Test Case 1: Create Batch with Single Assignment

### Steps
1. Navigate to `http://localhost:5173/batch/setup`
2. Click "Create Batch" card
3. Fill batch information:
   - Batch Number: `TEST-2025-001`
   - Species: Select "Atlantic Salmon (Salmo salar)"
   - Lifecycle Stage: Should show "Egg&Alevin" (disabled, auto-selected)
   - Status: Keep "ACTIVE"
   - Start Date: Today's date
   - Expected End Date: Leave blank
   - Notes: "Test batch with single assignment"
4. Fill location:
   - Geography: Select "Faroe Islands"
   - Freshwater Station: Select "Faroe Islands Freshwater Station 1"
5. Click "Add Container Assignment"
6. Fill assignment:
   - Hall: Select "Hall A"
   - Container: Select "Hall A-C01" (or any Egg & Alevin Tray)
   - Population Count: `350000`
   - Avg Weight: `0.001`
   - Notes: Leave blank
7. Observe real-time totals:
   - **Total Fish: 350,000**
   - **Total Biomass: 0.350 kg**
8. Click "Create Batch with Assignments"

### Expected Results
- ✅ Success toast: "Batch created with container assignments"
- ✅ Dialog closes
- ✅ Batch count increments by 1
- ✅ Can verify batch exists in backend: `curl http://localhost:8000/api/v1/batch/batches/`

## Test Case 2: Create Batch with Multiple Assignments

### Steps
1. Click "Create Batch" card again
2. Fill batch information:
   - Batch Number: `TEST-2025-002`
   - Species: "Atlantic Salmon"
   - Start Date: Today's date
3. Fill location:
   - Geography: "Faroe Islands"
   - Station: "Faroe Islands Freshwater Station 1"
4. Add **3 assignments**:
   
   **Assignment 1**:
   - Hall: "Hall A"
   - Container: "Hall A-C01"
   - Population: `350000`
   - Weight: `0.001`
   
   **Assignment 2**:
   - Hall: "Hall A"
   - Container: "Hall A-C02"
   - Population: `350000`
   - Weight: `0.001`
   
   **Assignment 3**:
   - Hall: "Hall A"
   - Container: "Hall A-C03"
   - Population: `350000`
   - Weight: `0.001`

5. Observe real-time totals:
   - **Total Fish: 1,050,000**
   - **Total Biomass: 1.050 kg**
6. Click "Create Batch with Assignments"

### Expected Results
- ✅ Success toast
- ✅ Batch created with 3 assignments
- ✅ All assignments active in database

## Test Case 3: Duplicate Container Prevention

### Steps
1. Click "Create Batch"
2. Fill batch info and location (same as before)
3. Add assignment 1:
   - Hall: "Hall A"
   - Container: "Hall A-C01"
   - Population: `100000`
   - Weight: `0.001`
4. Add assignment 2:
   - Hall: "Hall A"
   - Container dropdown should **not** show "Hall A-C01"
   - Select "Hall A-C02"

### Expected Results
- ✅ Container dropdown excludes already-selected containers
- ✅ Cannot select same container twice

## Test Case 4: Cascading Filter Validation

### Steps
1. Click "Create Batch"
2. Try to add assignment without selecting geography
   - **Expected**: "Add Container Assignment" button is disabled
3. Select geography
4. Try to add assignment without selecting station
   - **Expected**: "Add Container Assignment" button is disabled
5. Select station
6. Click "Add Container Assignment"
7. Try to select container without selecting hall
   - **Expected**: Container dropdown shows "Select hall first"
8. Select hall
   - **Expected**: Container dropdown shows available trays

### Expected Results
- ✅ Cascading filters work correctly
- ✅ Clear messaging at each step
- ✅ Buttons disabled appropriately

## Test Case 5: Minimum Assignment Validation

### Steps
1. Click "Create Batch"
2. Fill batch info and location
3. Don't add any assignments
4. Try to submit

### Expected Results
- ✅ "Create Batch with Assignments" button is disabled
- ✅ Cannot submit without at least 1 assignment

## Test Case 6: Remove Assignment

### Steps
1. Click "Create Batch"
2. Fill batch info and location
3. Add 3 assignments
4. Click trash icon on assignment 2
5. Observe totals recalculate

### Expected Results
- ✅ Assignment row removed
- ✅ Totals update immediately
- ✅ Removed container available in other dropdowns again

## Test Case 7: Real-time Biomass Calculation

### Steps
1. Click "Create Batch"
2. Fill batch info and location
3. Add assignment:
   - Hall: "Hall A"
   - Container: "Hall A-C01"
   - Population: `350000`
   - Weight: `0.001`
4. Observe assignment biomass badge shows "0.350 kg"
5. Change population to `700000`
6. Observe biomass updates to "0.700 kg"
7. Change weight to `0.002`
8. Observe biomass updates to "1.400 kg"

### Expected Results
- ✅ Biomass calculates immediately
- ✅ Formula: `biomass_kg = (population_count * avg_weight_g) / 1000`
- ✅ Displayed with 3 decimal places

## Test Case 8: Atomic Rollback (Advanced)

### Prerequisites
Stop backend server to simulate failure

### Steps
1. Stop Django: `lsof -ti:8000 | xargs kill`
2. Click "Create Batch"
3. Fill form with 2 assignments
4. Click "Create Batch with Assignments"
5. Observe error toast

### Expected Results
- ✅ Error toast shows
- ✅ No partial batch created
- ✅ Database state unchanged

### Cleanup
Restart Django: `cd AquaMind && python manage.py runserver`

## Verification Queries

### Check Batch Created
```bash
curl http://localhost:8000/api/v1/batch/batches/ | jq '.results[] | {id, batch_number, lifecycle_stage}'
```

### Check Assignments Created
```bash
curl http://localhost:8000/api/v1/batch/container-assignments/ | jq '.results[] | {id, batch, container, population_count, biomass_kg}'
```

### Check Lifecycle Stages
```bash
curl http://localhost:8000/api/v1/batch/lifecycle-stages/ | jq '.results[] | {id, name, order}'
```

Expected output:
```json
[
  {"id": 1, "name": "Egg&Alevin", "order": 1},
  {"id": 2, "name": "Fry", "order": 2},
  {"id": 3, "name": "Parr", "order": 3},
  {"id": 4, "name": "Smolt", "order": 4},
  {"id": 5, "name": "Post-Smolt", "order": 5},
  {"id": 6, "name": "Adult", "order": 6}
]
```

## Known Issues & Workarounds

### Issue 1: Container type filtering
**Symptom**: Some non-tray containers might appear in dropdown
**Cause**: Client-side filtering by name (not category)
**Workaround**: Only select containers with "Tray" or "Egg" in the name
**Fix**: Backend enhancement (add category filter to API)

### Issue 2: Container capacity validation
**Symptom**: No validation against container max_biomass_kg
**Cause**: Not implemented yet (planned for B2.2)
**Workaround**: User must check container capacity manually
**Fix**: Add validation in assignment schema

## Success Indicators

After completing all test cases:
- ✅ At least 2-3 batches created
- ✅ Each batch has 1-3 assignments
- ✅ All assignments show correct population and biomass
- ✅ No orphaned batches (batches without assignments)
- ✅ No duplicate container assignments
- ✅ Totals calculate correctly

## Next Steps

Once manual testing passes:
1. Review batch list page to ensure batches display correctly
2. Verify batch detail page shows assignments
3. Test editing existing batches (should still use old BatchForm)
4. Move to B2.2: Batch transfers


